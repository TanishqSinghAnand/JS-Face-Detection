const video = document.getElementById("video");

Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri("/models"),
  faceapi.nets.faceLandmark68Net.loadFromUri("/models"),
  faceapi.nets.faceRecognitionNet.loadFromUri("/models"),
  faceapi.nets.faceExpressionNet.loadFromUri("/models"),
]).then(startVideo);

function startVideo() {
  navigator.getUserMedia(
    { video: {} },
    (stream) => (video.srcObject = stream),
    (err) => console.error(err)
  );
}

video.addEventListener("play", () => {
  const canvas = faceapi.createCanvasFromMedia(video);
  document.body.append(canvas);
  const displaySize = { width: video.width, height: video.height };
  faceapi.matchDimensions(canvas,displaySize)
  setInterval(async () => {
    const detections = await faceapi
      .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks()
      .withFaceExpressions();
    const resizedDetections = faceapi.resizeResults(detections,displaySize)
    canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height)
    faceapi.draw.drawDetections(canvas,resizedDetections)
    faceapi.draw.drawFaceLandmarks(canvas,resizedDetections)
    faceapi.draw.drawFaceExpressions(canvas,resizedDetections)
  }, 100);
});

/*
[
    {
        "detection": {
            "_imageDims": {
                "_width": 640,
                "_height": 480
            },
            "_score": 0.9377792487633484,
            "_classScore": 0.9377792487633484,
            "_className": "",
            "_box": {
                "_x": 230.51338413467846,
                "_y": 212.5447148273307,
                "_width": 143.41494572617506,
                "_height": 124.78437581936359
            }
        },
        "landmarks": {
            "_imgDims": {
                "_width": 143,
                "_height": 124
            },
            "_shift": {
                "_x": 230.51338413467846,
                "_y": 212.5447148273307
            },
            "_positions": [
                {
                    "_x": 251.6103367071434,
                    "_y": 255.19658472040473
                },
                {
                    "_x": 253.59286038687668,
                    "_y": 269.2787035892326
                },
                {
                    "_x": 256.2311453085228,
                    "_y": 282.93034615019144
                },
                {
                    "_x": 259.2976085852667,
                    "_y": 294.68077840307535
                },
                {
                    "_x": 263.76088225951634,
                    "_y": 307.9343873451072
                },
                {
                    "_x": 270.871974350123,
                    "_y": 317.7868169734794
                },
                {
                    "_x": 279.26069963088474,
                    "_y": 324.42832579115213
                },
                {
                    "_x": 289.9963011156603,
                    "_y": 331.23144568899454
                },
                {
                    "_x": 306.3196001957937,
                    "_y": 335.39733232954325
                },
                {
                    "_x": 322.37629810085735,
                    "_y": 331.45347799757303
                },
                {
                    "_x": 332.2728327225729,
                    "_y": 325.18879069784464
                },
                {
                    "_x": 340.0682908009573,
                    "_y": 318.31992806890787
                },
                {
                    "_x": 346.77183345070324,
                    "_y": 307.3648609111625
                },
                {
                    "_x": 351.6582076262518,
                    "_y": 294.02421583631815
                },
                {
                    "_x": 353.68036541452847,
                    "_y": 281.1652406642753
                },
                {
                    "_x": 355.739446849732,
                    "_y": 268.05713047483744
                },
                {
                    "_x": 356.46002051344357,
                    "_y": 253.9227278421241
                },
                {
                    "_x": 263.3345534961506,
                    "_y": 239.99303307035743
                },
                {
                    "_x": 269.50338727345905,
                    "_y": 235.02025141218482
                },
                {
                    "_x": 277.47463753929577,
                    "_y": 232.89110155800162
                },
                {
                    "_x": 285.0527984212919,
                    "_y": 232.55468096235572
                },
                {
                    "_x": 291.89389699807606,
                    "_y": 234.45074345568
                },
                {
                    "_x": 317.73412117472134,
                    "_y": 234.56317867735206
                },
                {
                    "_x": 324.17308697214565,
                    "_y": 232.7475835869628
                },
                {
                    "_x": 331.202115149407,
                    "_y": 232.43761344650565
                },
                {
                    "_x": 339.542580575852,
                    "_y": 234.53959407308875
                },
                {
                    "_x": 345.32479640951595,
                    "_y": 239.22162582376777
                },
                {
                    "_x": 304.9740094255491,
                    "_y": 249.31642772653876
                },
                {
                    "_x": 305.25013557186566,
                    "_y": 258.35983743170084
                },
                {
                    "_x": 305.5473658155485,
                    "_y": 266.8504908273536
                },
                {
                    "_x": 305.35541740169964,
                    "_y": 274.99107064703287
                },
                {
                    "_x": 297.0385023068472,
                    "_y": 281.5756024310905
                },
                {
                    "_x": 301.00566774716816,
                    "_y": 282.8277815769035
                },
                {
                    "_x": 305.69983354320965,
                    "_y": 283.6315502116996
                },
                {
                    "_x": 310.5385018896147,
                    "_y": 282.32314791181864
                },
                {
                    "_x": 314.37405225744686,
                    "_y": 281.78393926122965
                },
                {
                    "_x": 274.06916412821255,
                    "_y": 249.80752481916724
                },
                {
                    "_x": 278.75778541079006,
                    "_y": 247.86298121908484
                },
                {
                    "_x": 285.2042007159277,
                    "_y": 247.3810378501731
                },
                {
                    "_x": 290.8044107567354,
                    "_y": 250.15722515085517
                },
                {
                    "_x": 286.2598573278471,
                    "_y": 252.47061540582953
                },
                {
                    "_x": 279.3377645324751,
                    "_y": 252.17626978853522
                },
                {
                    "_x": 318.3322297047659,
                    "_y": 250.05977143743812
                },
                {
                    "_x": 324.2383426140829,
                    "_y": 247.01219858625709
                },
                {
                    "_x": 331.0435275744482,
                    "_y": 247.34883906343757
                },
                {
                    "_x": 335.13517394772015,
                    "_y": 250.18129386404334
                },
                {
                    "_x": 330.7351742099806,
                    "_y": 252.33709003427802
                },
                {
                    "_x": 323.95705124845944,
                    "_y": 251.5231403301078
                },
                {
                    "_x": 287.1158304821535,
                    "_y": 300.35292376974405
                },
                {
                    "_x": 293.8207283627077,
                    "_y": 296.41603173712076
                },
                {
                    "_x": 301.89564100017986,
                    "_y": 293.81438602903665
                },
                {
                    "_x": 306.07854810467205,
                    "_y": 294.58640303114237
                },
                {
                    "_x": 310.07270309439144,
                    "_y": 293.53372110822977
                },
                {
                    "_x": 318.7156492184683,
                    "_y": 296.95954932668985
                },
                {
                    "_x": 326.0918295692488,
                    "_y": 300.6222878883201
                },
                {
                    "_x": 318.4695682834669,
                    "_y": 305.01089419821085
                },
                {
                    "_x": 312.67599067202053,
                    "_y": 307.53614677885355
                },
                {
                    "_x": 306.1508356045767,
                    "_y": 308.2638400981742
                },
                {
                    "_x": 300.26976037135563,
                    "_y": 307.5801452586967
                },
                {
                    "_x": 294.01078882923565,
                    "_y": 305.41626705625833
                },
                {
                    "_x": 288.3146812926813,
                    "_y": 300.40577663877787
                },
                {
                    "_x": 300.0188082765623,
                    "_y": 298.6570939014274
                },
                {
                    "_x": 306.04807672014675,
                    "_y": 298.80903758505167
                },
                {
                    "_x": 311.8729951094671,
                    "_y": 299.2087933013755
                },
                {
                    "_x": 324.355812997727,
                    "_y": 300.3213421295005
                },
                {
                    "_x": 311.98369786253414,
                    "_y": 301.3452805469352
                },
                {
                    "_x": 306.2979505967184,
                    "_y": 301.84114112356485
                },
                {
                    "_x": 300.65176499000034,
                    "_y": 301.5157755801994
                }
            ]
        },
        "unshiftedLandmarks": {
            "_imgDims": {
                "_width": 143,
                "_height": 124
            },
            "_shift": {
                "_x": 0,
                "_y": 0
            },
            "_positions": [
                {
                    "_x": 21.096952572464943,
                    "_y": 42.651869893074036
                },
                {
                    "_x": 23.07947625219822,
                    "_y": 56.733988761901855
                },
                {
                    "_x": 25.717761173844337,
                    "_y": 70.38563132286072
                },
                {
                    "_x": 28.784224450588226,
                    "_y": 82.13606357574463
                },
                {
                    "_x": 33.247498124837875,
                    "_y": 95.38967251777649
                },
                {
                    "_x": 40.358590215444565,
                    "_y": 105.24210214614868
                },
                {
                    "_x": 48.747315496206284,
                    "_y": 111.88361096382141
                },
                {
                    "_x": 59.48291698098183,
                    "_y": 118.68673086166382
                },
                {
                    "_x": 75.80621606111526,
                    "_y": 122.85261750221252
                },
                {
                    "_x": 91.8629139661789,
                    "_y": 118.90876317024231
                },
                {
                    "_x": 101.75944858789444,
                    "_y": 112.64407587051392
                },
                {
                    "_x": 109.55490666627884,
                    "_y": 105.77521324157715
                },
                {
                    "_x": 116.25844931602478,
                    "_y": 94.82014608383179
                },
                {
                    "_x": 121.14482349157333,
                    "_y": 81.47950100898743
                },
                {
                    "_x": 123.16698127985,
                    "_y": 68.62052583694458
                },
                {
                    "_x": 125.22606271505356,
                    "_y": 55.512415647506714
                },
                {
                    "_x": 125.9466363787651,
                    "_y": 41.378013014793396
                },
                {
                    "_x": 32.82116936147213,
                    "_y": 27.448318243026733
                },
                {
                    "_x": 38.990003138780594,
                    "_y": 22.475536584854126
                },
                {
                    "_x": 46.96125340461731,
                    "_y": 20.34638673067093
                },
                {
                    "_x": 54.539414286613464,
                    "_y": 20.009966135025024
                },
                {
                    "_x": 61.3805128633976,
                    "_y": 21.906028628349304
                },
                {
                    "_x": 87.22073704004288,
                    "_y": 22.018463850021362
                },
                {
                    "_x": 93.6597028374672,
                    "_y": 20.20286875963211
                },
                {
                    "_x": 100.68873101472855,
                    "_y": 19.892898619174957
                },
                {
                    "_x": 109.02919644117355,
                    "_y": 21.994879245758057
                },
                {
                    "_x": 114.8114122748375,
                    "_y": 26.676910996437073
                },
                {
                    "_x": 74.46062529087067,
                    "_y": 36.77171289920807
                },
                {
                    "_x": 74.7367514371872,
                    "_y": 45.81512260437012
                },
                {
                    "_x": 75.03398168087006,
                    "_y": 54.30577600002289
                },
                {
                    "_x": 74.84203326702118,
                    "_y": 62.44635581970215
                },
                {
                    "_x": 66.52511817216873,
                    "_y": 69.03088760375977
                },
                {
                    "_x": 70.4922836124897,
                    "_y": 70.28306674957275
                },
                {
                    "_x": 75.18644940853119,
                    "_y": 71.0868353843689
                },
                {
                    "_x": 80.02511775493622,
                    "_y": 69.77843308448792
                },
                {
                    "_x": 83.8606681227684,
                    "_y": 69.23922443389893
                },
                {
                    "_x": 43.55577999353409,
                    "_y": 37.26280999183655
                },
                {
                    "_x": 48.2444012761116,
                    "_y": 35.31826639175415
                },
                {
                    "_x": 54.69081658124924,
                    "_y": 34.83632302284241
                },
                {
                    "_x": 60.29102662205696,
                    "_y": 37.612510323524475
                },
                {
                    "_x": 55.74647319316864,
                    "_y": 39.92590057849884
                },
                {
                    "_x": 48.82438039779663,
                    "_y": 39.63155496120453
                },
                {
                    "_x": 87.81884557008743,
                    "_y": 37.51505661010742
                },
                {
                    "_x": 93.72495847940445,
                    "_y": 34.46748375892639
                },
                {
                    "_x": 100.53014343976974,
                    "_y": 34.80412423610687
                },
                {
                    "_x": 104.62178981304169,
                    "_y": 37.63657903671265
                },
                {
                    "_x": 100.22179007530212,
                    "_y": 39.79237520694733
                },
                {
                    "_x": 93.44366711378098,
                    "_y": 38.9784255027771
                },
                {
                    "_x": 56.60244634747505,
                    "_y": 87.80820894241333
                },
                {
                    "_x": 63.30734422802925,
                    "_y": 83.87131690979004
                },
                {
                    "_x": 71.3822568655014,
                    "_y": 81.26967120170593
                },
                {
                    "_x": 75.56516396999359,
                    "_y": 82.04168820381165
                },
                {
                    "_x": 79.55931895971298,
                    "_y": 80.98900628089905
                },
                {
                    "_x": 88.20226508378983,
                    "_y": 84.41483449935913
                },
                {
                    "_x": 95.57844543457031,
                    "_y": 88.07757306098938
                },
                {
                    "_x": 87.95618414878845,
                    "_y": 92.46617937088013
                },
                {
                    "_x": 82.16260653734207,
                    "_y": 94.99143195152283
                },
                {
                    "_x": 75.63745146989822,
                    "_y": 95.7191252708435
                },
                {
                    "_x": 69.75637623667717,
                    "_y": 95.03543043136597
                },
                {
                    "_x": 63.49740469455719,
                    "_y": 92.87155222892761
                },
                {
                    "_x": 57.80129715800285,
                    "_y": 87.86106181144714
                },
                {
                    "_x": 69.50542414188385,
                    "_y": 86.11237907409668
                },
                {
                    "_x": 75.53469258546829,
                    "_y": 86.26432275772095
                },
                {
                    "_x": 81.35961097478867,
                    "_y": 86.6640784740448
                },
                {
                    "_x": 93.84242886304855,
                    "_y": 87.7766273021698
                },
                {
                    "_x": 81.47031372785568,
                    "_y": 88.80056571960449
                },
                {
                    "_x": 75.78456646203995,
                    "_y": 89.29642629623413
                },
                {
                    "_x": 70.13838085532188,
                    "_y": 88.97106075286865
                }
            ]
        },
        "alignedRect": {
            "_imageDims": {
                "_width": 640,
                "_height": 480
            },
            "_score": 0.9377792487633484,
            "_classScore": 0.9377792487633484,
            "_className": "",
            "_box": {
                "_x": 241.1253683265134,
                "_y": 222.14164155820188,
                "_width": 125.8196205675602,
                "_height": 123.5516626596451
            }
        },
        "expressions": {
            "neutral": 0.9950921535491943,
            "happy": 0.0047844224609434605,
            "sad": 2.2637809138359444e-7,
            "angry": 0.00009621364006306976,
            "fearful": 1.2375839242295683e-9,
            "disgusted": 0.00002287035749759525,
            "surprised": 0.0000038991715882730205
        }
    }
]
*/
